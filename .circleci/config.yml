jobs:
  sonarcloud:
    docker:
      - image: 'node:latest'
    steps:
      - checkout
      - sonarcloud/scan
  test2:
    docker:
      - image: 'node:latest'
    steps:
      - checkout
      - run: apt-get install -y sudo # https://discuss.circleci.com/t/sudo-command-not-found/14208/4
      - run: ls -al /bin/sh && sudo rm /bin/sh && sudo ln -s /bin/bash /bin/sh && ls -al /bin/sh
      - run: npm install
      - snyk/scan
  build:
    docker:
      - image: 'node:latest'
    steps:
      - checkout
      - run: npm install
      - run: npm start
  test:
    docker:
      - image: 'node:latest'
    steps:
      - checkout
      - run: npm install -g mocha
      - run: npm install -g mocha-junit-reporter
      - run: npm install
      - run: mkdir ~/junit
      - run:
          command: mocha test --reporter mocha-junit-reporter
          environment:
            MOCHA_FILE: ~/junit/test-results.xml
          when: always
      - store_test_results:
          path: ~/junit

   
orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.3
  snyk: snyk/snyk@1.1.2
version: 2.1
workflows:
  main:
    jobs:
      # - sonarcloud:
        #  context: SonarCloud
      - test2
      # - build:
         # requires: 
           # - sonarcloud
      # - test
          # requires: 
            # - build
